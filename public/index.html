<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ChemHelp</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="css/styles.css">
<script>
    // Check if user is logged in
    if (!localStorage.getItem('chemhelp_currentUser')) {
        window.location.href = 'login.html';
    }
</script>
</head>
<body>

    <div class="toolbar" role="toolbar" aria-label="Main toolbar">
        <div class="logo" title="ChemHelp">üß™</div>
        <!-- Mobile hamburger toggle (restored) -->
        <button id="mobileToggle" class="menu-btn mobile-toggle" aria-label="Open tools" title="Open tools">‚ò∞</button>
        <!-- File / Edit / View / Object menus -->
        <div class="menu">
            <button class="menu-btn" id="menuFileBtn">File ‚ñæ</button>
            <div class="dropdown" id="menuFile">
                <button id="mNew">New</button>
                <button id="mOpen">Open...</button>
                <button id="mSave">Save</button>
                <button id="mExport">Export PNG</button>
            </div>
        </div>

        <div class="menu">
            <button class="menu-btn" id="menuEditBtn">Edit ‚ñæ</button>
            <div class="dropdown" id="menuEdit">
                <button id="mUndo">Undo</button>
                <button id="mRedo">Redo</button>
                <button id="mClear">Clear Canvas</button>
            </div>
        </div>

        <div class="menu">
            <button class="menu-btn" id="menuViewBtn">View ‚ñæ</button>
            <div class="dropdown" id="menuView">
                <button id="mToggleGrid">Toggle Grid</button>
                <button id="mToggleLabels">Toggle Labels</button>
                <button id="mCenter">Center View</button>
            </div>
        </div>

        <div class="menu">
            <button class="menu-btn" id="menuObjectBtn">Object ‚ñæ</button>
            <div class="dropdown" id="menuObject">
                <button id="mPeriodic">Open Periodic Table</button>
                <button id="mInsertElement">Insert Element (prompt)</button>
                <button id="mInsertPTImage">Insert Periodic Table Image</button>
            </div>
        </div>

        <div class="title">‚öõÔ∏è ChemHelp</div>
        <div style="flex:1"></div>
        <!-- Dark Mode Toggle -->
        <button id="darkModeToggle" class="menu-btn" style="background:rgba(0,102,204,0.15);border:1.5px solid rgba(0,102,204,0.3);" title="Toggle dark mode">üåì</button>
        <!-- Implicit H Toggle -->
        <button id="implicitHToggle" class="menu-btn" style="background:rgba(0,102,204,0.15);border:1.5px solid rgba(0,102,204,0.3);" title="Toggle implicit hydrogens">H: ON</button>
        <!-- User Profile -->
        <button id="userProfileBtn" onclick="openProfileModal()" class="menu-btn" style="background:rgba(220,38,38,0.15);border:1.5px solid rgba(220,38,38,0.3);" title="User profile">üë§ <span id="userNameDisplay">Profile</span></button>
        <!-- Gemini AI badge -->
        <div id="aiBadge" style="display:flex;align-items:center;gap:7px;margin-right:10px;">
            <svg viewBox="0 0 32 32" width="22" height="22"><circle cx="16" cy="16" r="16" fill="#0066cc"/><path d="M16 8v8l6 6" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            
        </div>
        <div class="small">Mode:</div>
        <div id="activeMode" class="kbd">Select</div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" style="position:fixed;top:20px;right:20px;z-index:5000;display:flex;flex-direction:column;gap:10px;"></div>

    <!-- User Profile Modal -->
    <div id="profileModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:3000;justify-content:center;align-items:center;flex-direction:column;">
        <div style="background:#fff;padding:32px;border-radius:16px;max-width:450px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom:20px;color:#1a3a5c;">User Profile</h2>
            
            <!-- Photo Section -->
            <div style="text-align:center;margin-bottom:24px;">
                <div id="profilePhoto" style="font-size:64px;margin-bottom:12px;height:120px;width:120px;display:flex;align-items:center;justify-content:center;background:#f0f4ff;border-radius:50%;margin:0 auto 12px auto;border:3px solid #5b6ee1;">üë§</div>
                <input type="file" id="photoUpload" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
                <button onclick="document.getElementById('photoUpload').click()" style="padding:8px 16px;background:#5b6ee1;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;font-weight:600;">
                    üì∑ Change Photo
                </button>
                <p id="photoStatus" style="font-size:0.8rem;color:#888;margin-top:8px;"></p>
            </div>
            
            <!-- Editable Name -->
            <div style="margin-bottom:16px;">
                <label style="display:block;font-weight:600;margin-bottom:4px;color:#1a3a5c;">Full Name:</label>
                <input type="text" id="profileNameInput" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:1rem;box-sizing:border-box;" placeholder="Your name">
            </div>
            
            <div id="profileInfo" style="margin-bottom:24px;padding:16px;background:#f0f4ff;border-radius:10px;">
                <p style="margin:0 0 8px 0;"><strong>Email:</strong> <span id="profileEmail">‚Äî</span></p>
                <p style="margin:0 0 8px 0;"><strong>Logged in as:</strong> <span id="loggedInAs" style="color:#0066cc;font-weight:600;">‚Äî</span></p>
                <p style="margin:0;"><strong>Structures Saved:</strong> <span id="profileStructures">0</span></p>
            </div>
            
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <button onclick="saveProfile()" style="flex:2;padding:12px;background:linear-gradient(135deg,#0066cc 0%,#0088ff 100%);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;">üíæ Save Profile</button>
                <button onclick="closeProfileModal()" style="flex:1;padding:12px;background:#e0eaff;color:#5b6ee1;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Close</button>
                <button onclick="doLogout()" style="flex:1;padding:12px;background:linear-gradient(135deg,#ff1744 0%,#ff5a7f 100%);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Logout</button>
            </div>
        </div>
    </div>

    <!-- Reactions Modal -->
    <div id="reactionModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:3001;align-items:center;justify-content:center;overflow-y:auto;padding:20px;">
        <div style="background:#fff;padding:32px;border-radius:16px;max-width:600px;box-shadow:0 20px 80px rgba(0,0,0,0.4);margin:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 id="reactionTitle" style="margin:0;color:#1a3a5c;">Reaction Details</h2>
                <button onclick="document.getElementById('reactionModal').style.display='none'" style="background:none;border:none;font-size:24px;cursor:pointer;color:#999;">√ó</button>
            </div>
            
            <div id="reactionDetails" style="margin-bottom:20px;">
                <p id="reactionDescription" style="color:#555;margin-bottom:12px;"></p>
                <div style="background:#f8fafc;padding:12px;border-radius:8px;border-left:3px solid #5b6ee1;margin-bottom:12px;">
                    <strong>Equation:</strong> <span id="reactionEquation" style="font-family:monospace;"></span>
                </div>
                <div style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:12px;">
                    <strong>Conditions:</strong>
                    <div id="reactionConditions" style="margin-top:8px;font-size:0.9rem;color:#666;"></div>
                </div>
                <div style="background:#f8fafc;padding:12px;border-radius:8px;">
                    <strong>Mechanism Steps:</strong>
                    <div id="reactionMechanism" style="margin-top:8px;font-size:0.9rem;color:#666;"></div>
                </div>
            </div>
            
            <div style="display:flex;gap:12px;">
                <button onclick="document.getElementById('reactionModal').style.display='none'" style="flex:1;padding:12px;background:#e0eaff;color:#5b6ee1;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;">Close</button>
                <button id="applyReactionBtn" style="flex:1;padding:12px;background:linear-gradient(135deg,#5b6ee1 0%,#4a5cc5 100%);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;">Apply Reaction</button>
            </div>
        </div>
    </div>

    <div class="container">
        <aside id="sidebar" class="sidebar" aria-label="Tools & templates">
            <div class="group">
                <h3>Tools</h3>
                <button class="btn" data-tool="select"><span>Select</span><span class="key-hint">S</span></button>
                <button class="btn" data-tool="atom"><span>Add Atom</span><span class="key-hint">A</span></button>
                <button class="btn" data-tool="bond-single"><span>Single Bond</span><span class="key-hint">1</span></button>
                <button class="btn" data-tool="bond-double"><span>Double Bond</span><span class="key-hint">2</span></button>
                <button class="btn" data-tool="bond-triple"><span>Triple Bond</span><span class="key-hint">3</span></button>
                <button class="btn" data-tool="bond-wedge"><span>Wedge Bond</span><span class="key-hint">W</span></button>
                <button class="btn" data-tool="bond-dashed"><span>Dashed Bond</span><span class="key-hint">D</span></button>
                <button class="btn" data-tool="ring-5"><span>5-Ring</span><span class="key-hint">5</span></button>
                <button class="btn" data-tool="ring-6"><span>6-Ring</span><span class="key-hint">6</span></button>
                <button class="btn" data-tool="ring-7"><span>7-Ring</span><span class="key-hint">7</span></button>
                <button class="btn" data-tool="chain"><span>Chain</span><span class="key-hint">C</span></button>
                <button class="btn" data-tool="erase"><span>Erase</span><span class="key-hint">E</span></button>
                <button class="btn" id="atomChargeBtn"><span>Add Charge</span><span class="key-hint">Q</span></button>
            </div>

            <div class="group">
                <h3>‚ö° Quick Add</h3>
                
                <!-- Quick Elements -->
                <div style="margin-bottom:8px;">
                    <small style="color:#888;font-weight:600;">Elements</small>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:4px;">
                        <button class="btn" id="quickAddC" style="font-size:0.85rem;padding:8px;"><span>C</span></button>
                        <button class="btn" id="quickAddN" style="font-size:0.85rem;padding:8px;"><span>N</span></button>
                        <button class="btn" id="quickAddO" style="font-size:0.85rem;padding:8px;"><span>O</span></button>
                        <button class="btn" id="quickAddS" style="font-size:0.85rem;padding:8px;"><span>S</span></button>
                        <button class="btn" id="quickAddP" style="font-size:0.85rem;padding:8px;"><span>P</span></button>
                        <button class="btn" id="quickAddCl" style="font-size:0.85rem;padding:8px;"><span>Cl</span></button>
                    </div>
                </div>

                <!-- Quick Functional Groups -->
                <div style="margin-bottom:8px;">
                    <small style="color:#888;font-weight:600;">Groups</small>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:4px;">
                        <button class="btn" id="quickAddCarbonyl" style="font-size:0.75rem;padding:8px;"><span>C=O</span></button>
                        <button class="btn" id="quickAddOH" style="font-size:0.75rem;padding:8px;"><span>OH</span></button>
                        <button class="btn" id="quickAddNH2" style="font-size:0.75rem;padding:8px;"><span>NH2</span></button>
                        <button class="btn" id="quickAddCOOH" style="font-size:0.75rem;padding:8px;"><span>COOH</span></button>
                        <button class="btn" id="quickAddCHO" style="font-size:0.75rem;padding:8px;"><span>CHO</span></button>
                        <button class="btn" id="quickAddCOOR" style="font-size:0.75rem;padding:8px;"><span>COOR</span></button>
                    </div>
                </div>

                <!-- Quick Rings -->
                <div style="margin-bottom:8px;">
                    <small style="color:#888;font-weight:600;">Rings</small>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:4px;">
                        <button class="btn" id="quickAddBenzene" style="font-size:0.75rem;padding:8px;"><span>Benzene</span></button>
                        <button class="btn" id="quickAddCyclo6" style="font-size:0.75rem;padding:8px;"><span>Cyclohexane</span></button>
                        <button class="btn" id="quickAddCyclo5" style="font-size:0.75rem;padding:8px;"><span>Cyclopentane</span></button>
                        <button class="btn" id="quickAddPyrrole" style="font-size:0.75rem;padding:8px;"><span>Pyrrole</span></button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px;">
                    <button class="btn" id="quickDuplicate" style="font-size:0.8rem;padding:8px;"><span>Duplicate</span></button>
                    <button class="btn" id="quickClear" style="font-size:0.8rem;padding:8px;"><span>Clear</span></button>
                </div>
            </div>

            <div class="group">
                <h3>üîç PubChem Import</h3>
                <input type="text" id="pubchemSearch" placeholder="Search molecule..." style="width:100%;padding:10px;border:1px solid #cfd8e8;border-radius:6px;font-size:0.9rem;margin-bottom:8px;box-sizing:border-box;">
                <button id="pubchemSearchBtn" class="btn" style="width:100%;padding:10px 16px;white-space:nowrap;"><span>üîç Search</span></button>
                <div id="pubchemResults" style="font-size:0.85rem;max-height:200px;overflow-y:auto;margin-top:10px;"></div>
            </div>

            <div class="group">
                <h3>Templates</h3>
                <button class="btn" data-template="benzene"><span>Benzene</span></button>
                <button class="btn" data-template="cyclohexane"><span>Cyclohexane</span></button>
                <button class="btn" data-template="cyclopentane"><span>Cyclopentane</span></button>
                <button class="btn" data-template="ethanol"><span>Ethanol</span></button>
            </div>

            <div class="group">
                <h3>Reactions</h3>
                <select id="reactionCategory" style="width:100%;padding:8px;border-radius:6px;border:1px solid #cfd8e8;margin-bottom:10px;font-size:0.9rem;">
                    <option value="">All Reactions</option>
                    <option value="Addition">Addition</option>
                    <option value="Elimination">Elimination</option>
                    <option value="Oxidation">Oxidation</option>
                    <option value="Substitution">Substitution</option>
                    <option value="Condensation">Condensation</option>
                    <option value="C-C Bond Formation">C-C Bond Formation</option>
                </select>
                <div id="applicableReactionsList" style="max-height:200px;overflow-y:auto;border:1px solid #e0e7f1;border-radius:6px;background:#f8fafc;">
                    <div style="padding:12px;color:#888;text-align:center;font-size:0.9rem;">Draw a molecule to see applicable reactions</div>
                </div>
            </div>

            <div class="group">
                <h3>Molecular Properties</h3>
                <div id="molPropsDisplay" style="background:#f8fafc;border-radius:10px;padding:12px;font-size:0.9rem;color:#23243a;line-height:1.8;border:1px solid #e0e7f1;">
                    <div><strong>Formula:</strong> <span id="molFormula">‚Äî</span></div>
                    <div><strong>Weight:</strong> <span id="molWeight">‚Äî</span> g/mol</div>
                    <div><strong>SMILES:</strong> <span id="molSmiles" style="word-break:break-all;font-family:monospace;">‚Äî</span></div>
                </div>
            </div>

            <div class="group">
                <h3>Export / Save</h3>
                <div class="footer-actions">
                    <button id="downloadJSON" class="btn">Download .json</button>
                    <button id="downloadPNG" class="btn">Download PNG</button>
                </div>
                <button id="clearBtn" class="btn" style="background:linear-gradient(90deg,#ff6b6b 60%,#ee5a52 100%);color:#fff;margin-top:12px;">Clear Canvas</button>
                <div class="legend">Tip: Save JSON to reopen your drawing later.</div>
            </div>
        </aside>

        <main class="canvas-wrap">
            <div class="drawing-area" id="drawingArea">
                <canvas id="drawingCanvas"></canvas>
            </div>
                <!-- Canvas-level AI Name button + result tab -->
                <div style="display:flex;align-items:center;gap:18px;margin-top:18px;">
                    <button id="aiNameBtnCanvas" class="btn ai-gemini-btn" style="min-width:140px;transition:transform 0.18s;">
                        <span class="ai-btn-icon" style="margin-right:8px;vertical-align:middle;">‚ú®</span>
                        <span class="ai-btn-label">AI Name</span>
                    </button>
                    <div id="aiNameTab" style="display:none;padding:10px 22px;background:linear-gradient(90deg,#f6f8ff 60%,#e9eaf3 100%);border-radius:10px;font-size:1.08rem;color:#23243a;box-shadow:0 2px 8px rgba(91,110,225,0.10);font-weight:600;min-width:120px;position:relative;">
                        <!-- Name result will go here -->
                    </div>
                </div>

                <div class="status-bar">
                <div id="status">Ready</div>
                <div style="flex:1"></div>
                <div class="small">Nodes: <span id="nodeCount">0</span></div>
                <div style="width:10px"></div>
                <div class="small">Bonds: <span id="bondCount">0</span></div>
            </div>
            
            <!-- Named Reaction insert feature -->
            
        </main>
    </div>

    <input id="fileInput" type="file" accept=".json" style="display:none">

    <!-- Quick Add and PubChem Integration -->
    <script src="js/quickAdd.js?v=3"></script>
    <script src="js/pubchemIntegration.js?v=3"></script>
    <script src="js/app.js?v=3"></script>
</body>
</html>